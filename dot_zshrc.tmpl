# Enable Powerlevel10k instant prompt. Should stay close to the top of ~/.zshrc.
# Initialization code that may require console input (password prompts, [y/n]
# confirmations, etc.) must go above this block; everything else may go below.
if [[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
  source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
fi

# Path to your Oh My Zsh installation.
export ZSH="$HOME/.oh-my-zsh"

# Set theme
ZSH_THEME="powerlevel10k/powerlevel10k"

# Oh My Zsh plugins
plugins=(
  git
  zsh-syntax-highlighting
  autojump
  zsh-autosuggestions
)

source $ZSH/oh-my-zsh.sh

# Autojump
[[ -s $HOME/.autojump/etc/profile.d/autojump.sh ]] && source $HOME/.autojump/etc/profile.d/autojump.sh

autoload -U compinit && compinit -u
DEFAULT_USER="{{ .name }}"

# >>> conda initialize >>>
# !! Contents within this block are managed by 'conda init' !!
__conda_setup="$("$HOME/miniconda/bin/conda" 'shell.zsh' 'hook' 2> /dev/null)"
if [ $? -eq 0 ]; then
    eval "$__conda_setup"
else
    if [ -f "$HOME/miniconda/etc/profile.d/conda.sh" ]; then
        . "$HOME/miniconda/etc/profile.d/conda.sh"
    else
        export PATH="$HOME/miniconda/bin:$PATH"
    fi
fi
unset __conda_setup
# <<< conda initialize <<<

{{- if eq .chezmoi.os "darwin" }}

# ========== macOS ç‰¹å®šé…ç½® ==========

# X11 settings (ç”¨äºŽè¿è¡Œ X11 åº”ç”¨)
export DISPLAY={{ .macOS.display }}

# ðŸº Homebrew
export PATH="{{ .macOS.homebrewPath }}:$PATH"

# ðŸ“¦ Flutter Version Manager (fvm)
export PUB_HOSTED_URL="https://pub.flutter-io.cn"
export FLUTTER_STORAGE_BASE_URL="https://storage.flutter-io.cn"
export PATH="$HOME/Library/Application Support/fvm/current/bin:$PATH"

# ðŸ“± Android SDK
export ANDROID_SDK_ROOT={{ .macOS.androidSdkRoot }}
export ANDROID_HOME={{ .macOS.androidSdkRoot }}
export PATH=$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$PATH
export PATH=$ANDROID_SDK_ROOT/platform-tools:$PATH
export PATH=$ANDROID_SDK_ROOT/emulator:$PATH

# ðŸ“ åº”ç”¨å¿«æ·æ–¹å¼
alias typora="open -a Typora"

# Docker CLI completions
fpath=($HOME/.docker/completions $fpath)

# fnm (Fast Node Manager)
FNM_PATH="{{ .macOS.homebrewPath }}/../opt/fnm/bin"
if [ -d "$FNM_PATH" ]; then
  eval "`fnm env`"
fi

# pnpm
export PNPM_HOME="$HOME/Library/pnpm"
case ":$PATH:" in
  *":$PNPM_HOME:"*) ;;
  *) export PATH="$PNPM_HOME:$PATH" ;;
esac

# Windsurf
export PATH="$HOME/.codeium/windsurf/bin:$PATH"

# iTerm2 Shell Integration
test -e "${HOME}/.iterm2_shell_integration.zsh" && source "${HOME}/.iterm2_shell_integration.zsh"

{{ else }}

# ========== Linux æœåŠ¡å™¨é…ç½® ==========

# Linux ç‰¹å®šé…ç½®
# åœ¨è¿™é‡Œæ·»åŠ ä»…ç”¨äºŽ Linux æœåŠ¡å™¨çš„é…ç½®

{{ end }}

# ========== é€šç”¨é…ç½® (æ‰€æœ‰å¹³å°) ==========

# é€šç”¨ PATH
export PATH="$HOME/.local/bin:$PATH"

# ðŸª Ruby (rbenv) - ä»…åœ¨å®‰è£…äº† rbenv æ—¶å¯ç”¨
if [ -d "$HOME/.rbenv" ]; then
    export PATH="$HOME/.rbenv/shims:$PATH"
    eval "$(rbenv init - zsh)"
fi

# â˜• Java (jenv) - ä»…åœ¨å®‰è£…äº† jenv æ—¶å¯ç”¨
if [ -d "$HOME/.jenv" ]; then
    export PATH="$HOME/.jenv/bin:$PATH"
    eval "$(jenv init -)"
fi

# Antigravity
if [ -d "$HOME/.antigravity/antigravity/bin" ]; then
    export PATH="$HOME/.antigravity/antigravity/bin:$PATH"
fi

# Bun
if [ -d "$HOME/.bun" ]; then
    export BUN_INSTALL="$HOME/.bun"
    export PATH="$BUN_INSTALL/bin:$PATH"
    [ -s "$HOME/.bun/_bun" ] && source "$HOME/.bun/_bun"
fi

# Powerlevel10k
[[ ! -f ~/.p10k.zsh ]] || source ~/.p10k.zsh

# ============ EnvTools: ShowInfo ============
# Detect shell version
if [ -n "$BASH_VERSION" ]; then
    SHELL_INFO="Bash ${BASH_VERSION%%.*}"
elif [ -n "$ZSH_VERSION" ]; then
    SHELL_INFO="Zsh ${ZSH_VERSION%%.*}"
else
    SHELL_INFO="Shell $(basename $SHELL)"
fi

# ANSI color codes
GREEN='\033[0;32m'
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${GREEN}>>> TOPCODER FULLSTACK EnvTools (${SHELL_INFO})${NC}"

# Detect Node.js and its manager
if command -v node >/dev/null 2>&1; then
    NODE_PATH=$(command -v node)
    NODE_VERSION=$(node --version 2>/dev/null)
    
    if echo "$NODE_PATH" | grep -q "volta"; then
        NODE_MANAGER="volta"
    elif echo "$NODE_PATH" | grep -q "fnm"; then
        NODE_MANAGER="fnm"
    elif echo "$NODE_PATH" | grep -q "nvm"; then
        NODE_MANAGER="nvm"
    else
        NODE_MANAGER="system"
    fi
    
    echo -e "    ${CYAN}Node: ${NODE_VERSION} (${NODE_MANAGER})${NC}"
else
    echo -e "    ${YELLOW}Node.js: Not found in PATH${NC}"
fi
# ============ End EnvTools: ShowInfo ============
